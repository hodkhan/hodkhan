{% extends "base.html" %}
{% load static %}

{% block title %}صفحه اصلی{% endblock %}

{% block header %}
    <meta name="description" content="هدخوان، خبرخوان سلیمان. خبرهای مورد علاقه خود را با هدخوان پیدا کنید">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        .container {
            max-width: 1500px;
        }
        .card.article {
            position: relative;
            padding-bottom: 50px; /* Add padding to the bottom of the card */
        }
        .article_feed {
            display: flex;
            align-items: center;
        }
        .follow_btn {
            /* position: absolute; */
            /* top: 15px; */
            /* right: 15px; */
            /* z-index: 2; */
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
            margin-left: 10px; /* Add margin to the left of the button */
        }
        .like_btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": "هدخوان",
            "description": "هدخوان، خبرخوان سلیمان. خبرهای مورد علاقه خود را با هدخوان پیدا کنید",
            "url": "{{ request.build_absolute_uri }}",
			"potentialAction": {
				"@type": "SearchAction",
				"target": "{{ request.build_absolute_uri }}/search?q={search_term}",
				"query-input": "required name=search_term"
			}
		}
    </script>
{% endblock %}

{% block body %}
    <div class="loading" id="articlesGridLoading">
        <div class="typewriter">
            <div class="slide"><i></i></div>
            <div class="paper"></div>
            <div class="keyboard"></div>
        </div>
        <h3 class="loading_title">در حال محاسبات روی اخبار...</h3>
        <p class="loading_info">صبر کن تا از غوره حلوا درست کنم</p>
    </div>
    <main class="grid" id="articlesGrid">
        <!-- Articles will be dynamically inserted here -->
        {% block main %}{% endblock %}
    </main>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
    <script>
        let articles = [];
        let i = 0;
        let eventSource = null;
        let messageCount = 0;

        function createArticleCard(article) {
            let followButtonText = article.is_following ? 'دنبال شده' : 'دنبال کردن';
            let followButtonClass = article.is_following ? 'following' : '';
            let card = `
            <div class="card article">
				<a href="/article/${article.id}" target="_blank">
				    <div class="article_info card_info block">
                        <div class="article_feed">
                            <img class="article_feed_favicon" src="${article.feed.favicon}">
				    	    <h5 class="article_feed_name">${article.feed.name}</h5>
                            <button class="follow_btn ${followButtonClass}" onclick="event.preventDefault(); event.stopPropagation(); toggleFollow('${article.feed.id}', this)">${followButtonText}</button>
                        </div>
                        <div class="whitespace"></div>
						<h5 class="article_pub">${timeAgo(article.published)}</h5>
                    </div>
					<img class="card_cover" src="${article.image}" alt="${article.title}">
					<div class="card_content container block">
                        <h2 class="article_title">${article.title}؛</h2>
						<p class="article_abstract" id="abs${article.id}">
                        </p>
					</div>
				</a>
                <div class="like_btn" onclick="likeArticle('${article.id}',this)" >
                    <img style="width: 20px" draggable="false"src="https://em-content.zobj.net/source/apple/81/heavy-black-heart_2764.png">
                    <div style="display: inline-block; margin-right: 5px; font-size: .9rem; color: red">پسند</div>
                </div>
            </div>
			`;
            return card;
        }

        function renderArticles(category = 'all') {
            console.log(articles)
            const grid = document.getElementById('articlesGrid');
            grid.innerHTML = '';
            articles.forEach(article => {
                if (category === 'all' || article.topic === category) {
                    grid.innerHTML += createArticleCard(article);
                }
                var i = 0

                function typeWriter() {
                    if (i < article.abstract.length) {
                        document.getElementById(`abs${article.id}`).innerHTML += article.abstract.charAt(i);
                        i++;
                        setTimeout(typeWriter, 10);
                    }
                }

                typeWriter()
            });
            const button = document.createElement("button");
            button.innerHTML = 'ادامه اخبار...';
            button.style = 'grid-column: 1 / -1;';
            button.addEventListener("click", start);
            grid.appendChild(button);

        }

        function handleStarClick(event) {
            if (event.target.classList.contains('star')) {
                const articleId = event.target.closest('.stars').dataset.articleId;
                const rating = event.target.dataset.rating;
                $.ajax({
                    type: "GET",
                    url: '/newsRating',
                    data: {
                        "result": {"n": rating, "id": articleId},
                    },
                    dataType: "json",
                });
                // Update the stars visually
                const stars = event.target.closest('.stars').children;
                Array.from(stars).forEach((star, index) => {
                    star.textContent = index < rating ? '★' : '☆';
                });
            }
        }

        document.getElementById('articlesGrid').addEventListener('click', handleStarClick);


        {% comment %} window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY + 500 >= document.body.offsetHeight && !isFetching) {
                isFetching = true;
                start();
            }
        }); {% endcomment %}

        function start() {
            fetch(`/api/feed/{{username}}/${i}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (data.result.length > 0) {
                        articles = data.result;
                        renderArticles();
                        i++;
                    }
                    isFetching = false;
                })
                .catch(() => {
                    isFetching = false;
                });
            document.getElementById('articlesGridLoading').remove()
        }

        start();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const signupConsent = document.getElementById('signup-consent');


            function showSignupConsent() {
                signupConsent.style.display = 'block';
            }


            function checkSignupConsent() {
                const consent = "{{user.is_authenticated}}"
                if (consent == "False") {
                    showSignupConsent();
                }
            }


            checkSignupConsent();
        });

        function likeArticle(id, el) {
            $.ajax({
                type: "GET",
                url: '/api/interaction',
                data: {
                    "result": {"type": "like", "article": id, "value": "2.5"},
                },
                dataType: "json",
            });
            el.remove();
            alert(`
            <div style="text-align: center">
            لایک با موفقیت ثبت شد
            </div>`, '3d', 3000)

        }


        function viewArticle(id, value) {
            $.ajax({
                type: "GET",
                url: '/api/interaction',
                data: {
                    "result": {"type": "view", "article": id, "value": value},
                },
                dataType: "json",
            });
        }


        function toggleFollow(feedId, button) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            fetch('/api/follow_feed/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({feed_id: feedId}),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'followed') {
                    button.textContent = 'دنبال شده';
                    button.classList.add('following');
                } else if (data.status === 'unfollowed') {
                    button.textContent = 'دنبال کردن';
                    button.classList.remove('following');
                } else if (data.error) {
                    console.error('Error:', data.error);
                    if (data.error === 'Authentication required') {
                        alert('برای دنبال کردن باید وارد شوید.');
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function followFeed(id) {
            $.ajax({
                type: "GET",
                url: '/api/interaction',
                data: {
                    "result": {"type": "follow", "feed": id, "value": "5"},
                },
                dataType: "json",
            });
        }

    </script>

    <script>
        function toEnglishDigits(str) {
            return str.replace(/[۰-۹]/g, d => "۰۱۲۳۴۵۶۷۸۹".indexOf(d));
        }

        function parseJalali(persianDateString) {
            let eng = toEnglishDigits(persianDateString); 
            let [date, time] = eng.split(" ");
            let [jy, jm, jd] = date.split("-").map(Number);
            let [hh, mm, ss] = time.split(":").map(Number);

            let g = jalaali.toGregorian(jy, jm, jd);

            return new Date(g.gy, g.gm - 1, g.gd, hh, mm, ss);
        }

        function timeAgo(persianDateString) {
            let publishedDate = parseJalali(persianDateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - publishedDate) / 1000);

            if (diffInSeconds < 60) return "همین الان";
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} دقیقه قبل`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} ساعت قبل`;
            return `${Math.floor(diffInSeconds / 86400)} روز قبل`;
        }
    </script>
{% endblock %}
