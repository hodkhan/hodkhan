{% extends "base.html" %}
{% load static %}

{% block title %}{{ article.title }}{% endblock %}

{% block header %}
    <link rel="stylesheet" href="{% static 'css/single.css' %}">
    <meta name="description" content="هدخوان، خبرخوان سلیمان. {{ article.title }}">
    <meta property="og:image" content="{{ article.image }}"/>
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "NewsArticle",
            "headline": "{{ article.title }}",
        "image": "{{ article.image }}",
        "datePublished": "{{ article.published|date:'Y-m-d' }}",
        "author": {
            "@type": "Organization",
            "name": "{{ article.feed }}",
            "url": "/feed/{{ article.feed }}"
        },
        "publisher": {
            "@type": "Organization",
            "name": "هدخوان",
            "logo": {
                "@type": "ImageObject",
                "url": "{% static 'images/HodHod.png' %}"
            }
        },
        "description": "{{ article.abstract }}",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "{{ request.build_absolute_uri }}"
        }
    }
    </script>
{% endblock %}

{% block main %}
    <img src="{{ article.image }}" alt="{{ article.title }}" class="article-image">
    <div class="article-content">
    <h1>{{ article.title }}</h1>
    <div class="article-meta">
        <span>تاریخ انتشار: {{ article.published }}</span>
        <div class="stars" data-article-id="1">
            <span class="star" data-rating="1">★</span>
            <span class="star" data-rating="2">★</span>
            <span class="star" data-rating="3">★</span>
            <span class="star" data-rating="4">☆</span>
            <span class="star" data-rating="5">☆</span>
        </div>
    </div>
    <div class="tags">
        <a class="tag-link" href="/topic/{{ article.topic }}"><span class="tag">{{ article.topic }}</span></a>
    </div>
    <div class="article-body">
        <p>{{ article.abstract }}</p>
    </div>
    <div class="author">
        <a class="author-link" href="/feed/{{ article.feed.id }}">
            <div class="author-info">
                <h3>{{ article.feed.name }}</h3>
            </div>
        </a>
        <a class="author-source" href="{{ article.link }}">
            <div class="author-info">
                <h3>منبع خبر</h3>
            </div>
        </a>
        {{ article.html|safe }}
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.querySelector('.stars').addEventListener('click', function (event) {
            if (event.target.classList.contains('star')) {
                const articleId = this.dataset.articleId;
                const rating = event.target.dataset.rating;
                console.log(`Article ID: ${articleId}, New Rating: ${rating}`);
                $.ajax({
                    type: "GET",
                    url: '/articleRating',
                    data: {
                        "result": {"n": rating, "id": {{article.id}}},
                    },
                    dataType: "json",
                });
                // Update the stars visually
                const stars = this.children;
                Array.from(stars).forEach((star, index) => {
                    star.textContent = index < rating ? '★' : '☆';
                });
            }
        });
    </script>
{% endblock %}