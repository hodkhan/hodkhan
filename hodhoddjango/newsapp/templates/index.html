{% extends "base.html" %}
{% load static %}

{% block title %}هدخوان &ndash; HodKhan{% endblock %}

{% block header %}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{% endblock %}

{% block scripts %}
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		let articles = [];
		let i = 0;
		let eventSource = null;
		let messageCount = 0;

		function createArticleCard(article) {
			const card = document.createElement('div');
			card.className = 'card';
			card.innerHTML = `
				<img src="${article.image}" alt="${article.title}">
				<div class="card-content">
					<div class="info">
						<h5 class="topic">${article.topic}</h5>
						<h5 class="pub">${article.published}</h5>
					</div>
					<h2>${article.title}</h2>
					<p>${article.abstract}</p>
					<div class="con-star">
						<a href="${article.link}" target="_blank">ادامه مطلب</a>
						<div class="stars" data-article-id="${article.id}">
							${[1,2,3,4,5].map(star => `<span class="star" data-rating="${star}" alt="${article.stars}">${star <= article.stars ? '★' : '☆'}</span>`).join('')}
						</div>
					</div>
				</div>
			`;
			return card;
		}

        function renderArticles(category = 'all') {
			// articles = articles.sort((a,b) => b.stars - a.stars);
            const grid = document.getElementById('articlesGrid');
            grid.innerHTML = '';
            articles.forEach(article => {
                if (category === 'all' || article.topic === category) {
                    grid.appendChild(createArticleCard(article));
                }
            });
			const button = document.createElement("button");
			button.innerHTML = 'ادامه اخبار...';
			button.style = 'grid-column: 1 / -1;';
			button.addEventListener("click", start);
			grid.appendChild(button);
        }

		function handleStarClick(event) {
			if (event.target.classList.contains('star')) {
				const articleId = event.target.closest('.stars').dataset.articleId;
				const rating = event.target.dataset.rating;
				$.ajax({
					type: "GET",
					url: '/newsRating',
					data: {
						"result": {"n": rating, "id": articleId},
					},
					dataType: "json",
				});
				// Update the stars visually
				const stars = event.target.closest('.stars').children;
				Array.from(stars).forEach((star, index) => {
					star.textContent = index < rating ? '★' : '☆';
				});
			}
		}

		document.getElementById('articlesGrid').addEventListener('click', handleStarClick);

		function start() {
			// بستن EventSource قبلی (اگر وجود داشته باشد)
			if (eventSource) {
				eventSource.close();
			}
		
			// ریست کردن تعداد پیام‌ها
			messageCount = 0;
		
			// ایجاد EventSource جدید
			console.log(`/api/stream-articles/${i}`);
			eventSource = new EventSource(`/api/stream-articles/${i}`);
		
			eventSource.onmessage = function(event) {
				const newArticle = JSON.parse(event.data);
				newArticle['stars'] = Number(newArticle['stars']);
				articles.push(newArticle);
				renderArticles();
		
				// افزایش تعداد پیام‌های دریافتی
				messageCount += 1;
		
				// اگر دو پیام دریافت شد، اتصال را ببندید
				if (messageCount >= 12) {
					eventSource.close();
					i += 1; // برای رفتن به مجموعه بعدی اخبار
				}
			};
		
			eventSource.onerror = function(error) {
				console.error("EventSource failed:", error);
				eventSource.close();
			};
		
			eventSource.onopen = function() {
				console.log("EventSource connection opened.");
			};
		}
		
		// اولین بار تابع start را فراخوانی کنید
		start();
    </script>
{% endblock %}